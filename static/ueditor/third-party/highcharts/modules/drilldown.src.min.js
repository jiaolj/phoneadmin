/**
 * Highcharts Drilldown plugin
 * 
 * Author: Torstein Honsi
 * Last revision: 2013-02-18
 * License: MIT License
 *
 * Demo: http://jsfiddle.net/highcharts/Vf3yT/
 */

/*global HighchartsAdapter*/(function(e){function v(b,a,c){return"rgba("+[Math.round(b[0]+(a[0]-b[0])*c),Math.round(b[1]+(a[1]-b[1])*c),Math.round(b[2]+(a[2]-b[2])*c),b[3]+(a[3]-b[3])*c].join()+")"}var q=function(){},m=e.getOptions(),h=e.each,r=e.extend,t=e.wrap,k=e.Chart,l=e.seriesTypes,n=l.pie,p=l.column,w=HighchartsAdapter.fireEvent;r(m.lang,{drillUpText:"\u25c1 Back to {series.name}"});m.drilldown={activeAxisLabelStyle:{cursor:"pointer",color:"#039",fontWeight:"bold",textDecoration:"underline"},activeDataLabelStyle:{cursor:"pointer",color:"#039",fontWeight:"bold",textDecoration:"underline"},animation:{duration:500},drillUpButton:{position:{align:"right",x:-10,y:10}}};e.SVGRenderer.prototype.Element.prototype.fadeIn=function(){this.attr({opacity:.1,visibility:"visible"}).animate({opacity:1},{duration:250})};k.prototype.drilldownLevels=[];k.prototype.addSeriesAsDrilldown=function(b,a){var c=b.series,d=c.xAxis,f=c.yAxis,g;g=b.color||c.color;var e;a=r({color:g},a);e=HighchartsAdapter.inArray(this,c.points);g={seriesOptions:c.userOptions,shapeArgs:b.shapeArgs,bBox:b.graphic.getBBox(),color:g,newSeries:a,pointOptions:c.options.data[e],pointIndex:e,oldExtremes:{xMin:d&&d.userMin,xMax:d&&d.userMax,yMin:f&&f.userMin,yMax:f&&f.userMax}};this.drilldownLevels.push(g);g=this.addSeries(a,!1);d&&(d.oldPos=d.pos,d.userMin=d.userMax=null,f.userMin=f.userMax=null);c.type===g.type&&(g.animate=g.animateDrilldown||q,g.options.animation=!0);c.remove(!1);this.redraw();this.showDrillUpButton()};k.prototype.getDrilldownBackText=function(){return this.options.lang.drillUpText.replace("{series.name}",this.drilldownLevels[this.drilldownLevels.length-1].seriesOptions.name)};k.prototype.showDrillUpButton=function(){var b=this,a=this.getDrilldownBackText(),c=b.options.drilldown.drillUpButton;this.drillUpButton?this.drillUpButton.attr({text:a}).align():this.drillUpButton=this.renderer.button(a,null,null,function(){b.drillUp()}).attr(r({align:c.position.align,zIndex:9},c.theme)).add().align(c.position,!1,c.relativeTo||"plotBox")};k.prototype.drillUp=function(){var b=this.drilldownLevels.pop(),a=this.series[0],c=b.oldExtremes,d=this.addSeries(b.seriesOptions,!1);w(this,"drillup",{seriesOptions:b.seriesOptions});d.type===a.type&&(d.drilldownLevel=b,d.animate=d.animateDrillupTo||q,d.options.animation=!0,a.animateDrillupFrom&&a.animateDrillupFrom(b));a.remove(!1);d.xAxis&&(d.xAxis.setExtremes(c.xMin,c.xMax,!1),d.yAxis.setExtremes(c.yMin,c.yMax,!1));this.redraw();0===this.drilldownLevels.length?this.drillUpButton=this.drillUpButton.destroy():this.drillUpButton.attr({text:this.getDrilldownBackText()}).align()};n.prototype.animateDrilldown=function(b){var a=this.chart.drilldownLevels[this.chart.drilldownLevels.length-1],c=this.chart.options.drilldown.animation,d=a.shapeArgs,f=d.start,g=(d.end-f)/this.points.length,k=e.Color(a.color).rgba;b||h(this.points,function(a,b){var h=e.Color(a.color).rgba;a.graphic.attr(e.merge(d,{start:f+b*g,end:f+(b+1)*g})).animate(a.shapeArgs,e.merge(c,{step:function(a,d){"start"===d.prop&&this.attr({fill:v(k,h,d.pos)})}}))})};n.prototype.animateDrillupTo=p.prototype.animateDrillupTo=function(b){if(!b){var a=this,c=a.drilldownLevel;h(this.points,function(a){a.graphic.hide();a.dataLabel&&a.dataLabel.hide();a.connector&&a.connector.hide()});setTimeout(function(){h(a.points,function(a,b){var e=b===c.pointIndex?"show":"fadeIn";a.graphic[e]();if(a.dataLabel)a.dataLabel[e]();if(a.connector)a.connector[e]()})},Math.max(this.chart.options.drilldown.animation.duration-50,0));this.animate=q}};p.prototype.animateDrilldown=function(b){var a=this.chart.drilldownLevels[this.chart.drilldownLevels.length-1].shapeArgs,c=this.chart.options.drilldown.animation;b||(a.x+=this.xAxis.oldPos-this.xAxis.pos,h(this.points,function(b){b.graphic.attr(a).animate(b.shapeArgs,c)}))};p.prototype.animateDrillupFrom=n.prototype.animateDrillupFrom=function(b){var a=this.chart.options.drilldown.animation,c=this.group;delete this.group;h(this.points,function(d){var f=d.graphic,g=e.Color(d.color).rgba;delete d.graphic;f.animate(b.shapeArgs,e.merge(a,{step:function(a,c){"start"===c.prop&&this.attr({fill:v(g,e.Color(b.color).rgba,c.pos)})},complete:function(){f.destroy();c&&(c=c.destroy())}}))})};e.Point.prototype.doDrilldown=function(){for(var b=this.series.chart,a=b.options.drilldown,c=a.series.length,d;c--&&!d;)a.series[c].id===this.drilldown&&(d=a.series[c]);w(b,"drilldown",{point:this,seriesOptions:d});d&&b.addSeriesAsDrilldown(this,d)};t(e.Point.prototype,"init",function(b,a,c,d){var f=b.call(this,a,c,d);b=a.chart;a=(a=a.xAxis&&a.xAxis.ticks[d])&&a.label;f.drilldown?(e.addEvent(f,"click",function(){f.doDrilldown()}),a&&(a._basicStyle||(a._basicStyle=a.element.getAttribute("style")),a.addClass("highcharts-drilldown-axis-label").css(b.options.drilldown.activeAxisLabelStyle).on("click",function(){f.doDrilldown&&f.doDrilldown()}))):a&&a._basicStyle&&a.element.setAttribute("style",a._basicStyle);return f});t(e.Series.prototype,"drawDataLabels",function(b){var a=this.chart.options.drilldown.activeDataLabelStyle;b.call(this);h(this.points,function(b){if(b.drilldown&&b.dataLabel)b.dataLabel.attr({"class":"highcharts-drilldown-data-label"}).css(a).on("click",function(){b.doDrilldown()})})});p.prototype.supportsDrilldown=!0;n.prototype.supportsDrilldown=!0;var u,m=function(b){b.call(this);h(this.points,function(a){a.drilldown&&a.graphic&&a.graphic.attr({"class":"highcharts-drilldown-point"}).css({cursor:"pointer"})})};for(u in l)l[u].prototype.supportsDrilldown&&t(l[u].prototype,"drawTracker",m)})(Highcharts);