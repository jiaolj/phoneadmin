/**
 * @license Map plugin v0.1 for Highcharts
 *
 * (c) 2011-2013 Torstein Hønsi
 *
 * License: www.highcharts.com/license
 */

/* 
 * See www.highcharts.com/studies/world-map.htm for use case.
 *
 * To do:
 * - Optimize long variable names and alias adapter methods and Highcharts namespace variables
 * - Zoom and pan GUI
 *//*
 Map plugin v0.1 for Highcharts

 (c) 2011-2013 Torstein Hønsi

 License: www.highcharts.com/license
*/
(function(g){function B(a,b,c){for(var d=4,e=[];d--;)e[d]=Math.round(b.rgba[d]+(a.rgba[d]-b.rgba[d])*(1-c));return"rgba("+e.join(",")+")"}var v=g.Axis,C=g.Chart,w=g.Point,D=g.Pointer,n=g.each,z=g.extend,t=g.merge,q=g.pick,E=g.numberFormat,F=g.getOptions(),m=g.seriesTypes,u=F.plotOptions,x=g.wrap,y=g.Color,A=function(){};F.mapNavigation={buttonOptions:{align:"right",verticalAlign:"bottom",x:0,width:18,height:18,style:{fontSize:"15px",fontWeight:"bold",textAlign:"center"}},buttons:{zoomIn:{onclick:function(){this.mapZoom(.5)},text:"+",y:-32},zoomOut:{onclick:function(){this.mapZoom(2)},text:"-",y:0}}};g.splitPath=function(a){var b;a=a.replace(/([A-Za-z])/g," $1 ");a=a.replace(/^\s*/,"").replace(/\s*$/,"");a=a.split(/[ ,]+/);for(b=0;b<a.length;b++)/[a-zA-Z]/.test(a[b])||(a[b]=parseFloat(a[b]));return a};g.maps={};x(v.prototype,"getSeriesExtremes",function(a){var b=this.isXAxis,c,d,e=[];n(this.series,function(a,b){a.useMapGeometry&&(e[b]=a.xData,a.xData=[])});a.call(this);c=q(this.dataMin,Number.MAX_VALUE);d=q(this.dataMax,Number.MIN_VALUE);n(this.series,function(a,k){a.useMapGeometry&&(c=Math.min(c,a[b?"minX":"minY"]),d=Math.max(d,a[b?"maxX":"maxY"]),a.xData=e[k])});this.dataMin=c;this.dataMax=d});x(v.prototype,"setAxisTranslation",function(a){var b=this.chart,c=b.plotWidth/b.plotHeight,d=this.isXAxis,e=b.xAxis[0];a.call(this);"map"!==b.options.chart.type||d||void 0===e.transA||(this.transA=e.transA=Math.min(this.transA,e.transA),a=(e.max-e.min)/(this.max-this.min),e=a>c?this:e,c=(e.max-e.min)*e.transA,e.minPixelPadding=(e.len-c)/2)});x(C.prototype,"render",function(a){var b=this,c=b.options.mapNavigation;a.call(b);b.renderMapNavigation();c.zoomOnDoubleClick&&g.addEvent(b.container,"dblclick",function(a){b.pointer.onContainerDblClick(a)});c.zoomOnMouseWheel&&g.addEvent(b.container,void 0===document.onmousewheel?"DOMMouseScroll":"mousewheel",function(a){b.pointer.onContainerMouseWheel(a)})});z(D.prototype,{onContainerDblClick:function(a){var b=this.chart;a=this.normalize(a);b.isInsidePlot(a.chartX-b.plotLeft,a.chartY-b.plotTop)&&b.mapZoom(.5,b.xAxis[0].toValue(a.chartX),b.yAxis[0].toValue(a.chartY))},onContainerMouseWheel:function(a){var b=this.chart,c;a=this.normalize(a);c=a.detail||-(a.wheelDelta/120);b.isInsidePlot(a.chartX-b.plotLeft,a.chartY-b.plotTop)&&b.mapZoom(0<c?2:.5,b.xAxis[0].toValue(a.chartX),b.yAxis[0].toValue(a.chartY))}});x(D.prototype,"init",function(a,b,c){a.call(this,b,c);c.mapNavigation.enableTouchZoom&&(this.pinchX=this.pinchHor=this.pinchY=this.pinchVert=!0)});z(C.prototype,{renderMapNavigation:function(){var a=this,b=this.options.mapNavigation,c=b.buttons,d,e,f,k=function(){this.handler.call(a)};if(b.enableButtons)for(d in c)c.hasOwnProperty(d)&&(f=t(b.buttonOptions,c[d]),e=a.renderer.button(f.text,0,0,k).attr({width:f.width,height:f.height}).css(f.style).add(),e.handler=f.onclick,e.align(z(f,{width:e.width,height:e.height}),null,"spacingBox"))},fitToBox:function(a,b){n([["x","width"],["y","height"]],function(c){var d=c[0];c=c[1];a[d]+a[c]>b[d]+b[c]&&(a[c]>b[c]?(a[c]=b[c],a[d]=b[d]):a[d]=b[d]+b[c]-a[c]);a[c]>b[c]&&(a[c]=b[c]);a[d]<b[d]&&(a[d]=b[d])});return a},mapZoom:function(a,b,c){if(!this.isMapZooming){var d=this,e=d.xAxis[0],f=e.max-e.min,k=q(b,e.min+f/2);b=f*a;var f=d.yAxis[0],h=f.max-f.min;c=q(c,f.min+h/2);a*=h;k-=b/2;h=c-a/2;c=q(d.options.chart.animation,!0);b=d.fitToBox({x:k,y:h,width:b,height:a},{x:e.dataMin,y:f.dataMin,width:e.dataMax-e.dataMin,height:f.dataMax-f.dataMin});e.setExtremes(b.x,b.x+b.width,!1);f.setExtremes(b.y,b.y+b.height,!1);if(e=c?c.duration||500:0)d.isMapZooming=!0,setTimeout(function(){d.isMapZooming=!1},e);d.redraw()}}});u.map=t(u.scatter,{animation:!1,nullColor:"#F8F8F8",borderColor:"silver",borderWidth:1,marker:null,stickyTracking:!1,dataLabels:{verticalAlign:"middle"},turboThreshold:0,tooltip:{followPointer:!0,pointFormat:"{point.name}: {point.y}\x3cbr/\x3e"},states:{normal:{animation:!0}}});v=g.extendClass(w,{applyOptions:function(a,b){var c=w.prototype.applyOptions.call(this,a,b);c.path&&"string"===typeof c.path&&(c.path=c.options.path=g.splitPath(c.path));return c},onMouseOver:function(){clearTimeout(this.colorInterval);w.prototype.onMouseOver.call(this)},onMouseOut:function(){var a=this,b=+new Date,c=y(a.options.color),d=y(a.pointAttr.hover.fill),e=a.series.options.states.normal.animation,f=e&&(e.duration||500);f&&4===c.rgba.length&&4===d.rgba.length&&(delete a.pointAttr[""].fill,clearTimeout(a.colorInterval),a.colorInterval=setInterval(function(){var e=(new Date-b)/f,h=a.graphic;1<e&&(e=1);h&&h.attr("fill",B(d,c,e));1<=e&&clearTimeout(a.colorInterval)},13));w.prototype.onMouseOut.call(a)}});m.map=g.extendClass(m.scatter,{type:"map",pointAttrToOptions:{stroke:"borderColor","stroke-width":"borderWidth",fill:"color"},colorKey:"y",pointClass:v,trackerGroups:["group","markerGroup","dataLabelsGroup"],getSymbol:A,supportsDrilldown:!0,getExtremesFromAll:!0,useMapGeometry:!0,init:function(a){var b=this,c=a.options.legend.valueDecimals,d=[],e,f,k,h,l,r,p;r="horizontal"===a.options.legend.layout;g.Series.prototype.init.apply(this,arguments);l=b.options.colorRange;(h=b.options.valueRanges)?(n(h,function(a){f=a.from;k=a.to;e="";void 0===f?e="\x3c ":void 0===k&&(e="\x3e ");void 0!==f&&(e+=E(f,c));void 0!==f&&void 0!==k&&(e+=" - ");void 0!==k&&(e+=E(k,c));d.push(g.extend({chart:b.chart,name:e,options:{},drawLegendSymbol:m.area.prototype.drawLegendSymbol,visible:!0,setState:function(){},setVisible:function(){}},a))}),b.legendItems=d):l&&(f=l.from,k=l.to,h=l.fromLabel,l=l.toLabel,p=r?[0,0,1,0]:[0,1,0,0],r||(r=h,h=l,l=r),r={linearGradient:{x1:p[0],y1:p[1],x2:p[2],y2:p[3]},stops:[[0,f],[1,k]]},d=[{chart:b.chart,options:{},fromLabel:h,toLabel:l,color:r,drawLegendSymbol:this.drawLegendSymbolGradient,visible:!0,setState:function(){},setVisible:function(){}}],b.legendItems=d)},drawLegendSymbol:m.area.prototype.drawLegendSymbol,drawLegendSymbolGradient:function(a,b){var c=a.options.symbolPadding,d=q(a.options.padding,8),e,f,k=this.chart.renderer.fontMetrics(a.options.itemStyle.fontSize).h,h="horizontal"===a.options.layout,l;l=q(a.options.rectangleLength,200);h?(e=-(c/2),f=0):(e=-l+a.baseline-c/2,f=d+k);b.fromText=this.chart.renderer.text(b.fromLabel,f,e).attr({zIndex:2}).add(b.legendGroup);f=b.fromText.getBBox();b.legendSymbol=this.chart.renderer.rect(h?f.x+f.width+c:f.x-k-c,f.y,h?l:k,h?k:l,2).attr({zIndex:1}).add(b.legendGroup);l=b.legendSymbol.getBBox();b.toText=this.chart.renderer.text(b.toLabel,l.x+l.width+c,h?e:l.y+l.height-c).attr({zIndex:2}).add(b.legendGroup);e=b.toText.getBBox();h?(a.offsetWidth=f.width+l.width+e.width+2*c+d,a.itemY=k+d):(a.offsetWidth=Math.max(f.width,e.width)+c+l.width+d,a.itemY=l.height+d,a.itemX=c)},getBox:function(a){var b=Number.MIN_VALUE,c=Number.MAX_VALUE,d=Number.MIN_VALUE,e=Number.MAX_VALUE;n(a||this.options.data,function(a){for(var k=a.path,h=k.length,l=!1,g=Number.MIN_VALUE,p=Number.MAX_VALUE,m=Number.MIN_VALUE,n=Number.MAX_VALUE;h--;)"number"!==typeof k[h]||isNaN(k[h])||(l?(g=Math.max(g,k[h]),p=Math.min(p,k[h])):(m=Math.max(m,k[h]),n=Math.min(n,k[h])),l=!l);a._maxX=g;a._minX=p;a._maxY=m;a._minY=n;b=Math.max(b,g);c=Math.min(c,p);d=Math.max(d,m);e=Math.min(e,n)});this.minY=e;this.maxY=d;this.minX=c;this.maxX=b},translatePath:function(a){var b=!1,c=this.xAxis,d=this.yAxis,e;a=[].concat(a);for(e=a.length;e--;)"number"===typeof a[e]&&(a[e]=b?Math.round(c.translate(a[e])):Math.round(d.len-d.translate(a[e])),b=!b);return a},setData:function(){g.Series.prototype.setData.apply(this,arguments);this.getBox()},translate:function(){var a=this,b=Number.MAX_VALUE,c=Number.MIN_VALUE;a.generatePoints();n(a.data,function(d){d.shapeType="path";d.shapeArgs={d:a.translatePath(d.path)};"number"===typeof d.y&&(d.y>c?c=d.y:d.y<b&&(b=d.y))});a.translateColors(b,c)},translateColors:function(a,b){var c=this.options,d=c.valueRanges,e=c.colorRange,f=this.colorKey,k,h;e&&(k=y(e.from),h=y(e.to));n(this.data,function(g){var m=g[f],p,n,q;if(d)for(q=d.length;q--;){if(p=d[q],k=p.from,h=p.to,(void 0===k||m>=k)&&(void 0===h||m<=h)){n=p.color;break}}else e&&void 0!==m&&(p=1-(b-m)/(b-a),n=null===m?c.nullColor:B(k,h,p));n&&(g.color=null,g.options.color=n)})},drawGraph:A,drawDataLabels:A,drawPoints:function(){var a=this.xAxis,b=this.yAxis,c=this.colorKey;n(this.data,function(a){a.plotY=1;null===a[c]&&(a[c]=0,a.isNull=!0)});m.column.prototype.drawPoints.apply(this);n(this.data,function(d){var e=d.dataLabels,f=a.toPixels(d._minX,!0),g=a.toPixels(d._maxX,!0),h=b.toPixels(d._minY,!0),l=b.toPixels(d._maxY,!0);d.plotX=Math.round(f+(g-f)*q(e&&e.anchorX,.5));d.plotY=Math.round(h+(l-h)*q(e&&e.anchorY,.5));d.isNull&&(d[c]=null)});g.Series.prototype.drawDataLabels.call(this)},animateDrilldown:function(a){var b=this.chart.plotBox,c=this.chart.drilldownLevels[this.chart.drilldownLevels.length-1],d=c.bBox,e=this.chart.options.drilldown.animation;a||(a=Math.min(d.width/b.width,d.height/b.height),c.shapeArgs={scaleX:a,scaleY:a,translateX:d.x,translateY:d.y},n(this.points,function(a){a.graphic.attr(c.shapeArgs).animate({scaleX:1,scaleY:1,translateX:0,translateY:0},e)}),delete this.animate)},animateDrillupFrom:function(a){m.column.prototype.animateDrillupFrom.call(this,a)},animateDrillupTo:function(a){m.column.prototype.animateDrillupTo.call(this,a)}});u.mapline=t(u.map,{lineWidth:1,backgroundColor:"none"});m.mapline=g.extendClass(m.map,{type:"mapline",pointAttrToOptions:{stroke:"color","stroke-width":"lineWidth",fill:"backgroundColor"},drawLegendSymbol:m.line.prototype.drawLegendSymbol});u.mappoint=t(u.scatter,{dataLabels:{enabled:!0,format:"{point.name}",color:"black",style:{textShadow:"0 0 5px white"}}});m.mappoint=g.extendClass(m.scatter,{type:"mappoint"});g.Map=function(a,b){var c={endOnTick:!1,gridLineWidth:0,labels:{enabled:!1},lineWidth:0,minPadding:0,maxPadding:0,startOnTick:!1,tickWidth:0,title:null},d;d=a.series;a.series=null;a=t({chart:{type:"map",panning:"xy"},xAxis:c,yAxis:t(c,{reversed:!0})},a,{chart:{inverted:!1}});a.series=d;return new g.Chart(a,b)}})(Highcharts);