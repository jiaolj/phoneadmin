/**
 * User: Jinqn
 * Date: 14-04-08
 * Time: 下午16:34
 * 上传图片对话框逻辑代码,包括tab: 远程图片/上传图片/在线图片/搜索图片
 */(function(){function z(){for(var a=$G("tabhead").children,b=0;b<a.length;b++)domUtils.on(a[b],"click",function(a){v((a.target||a.srcElement).getAttribute("data-content-id"))});v("upload")}function v(a){if(a){var b,c,e=$G("tabhead").children;for(b=0;b<e.length;b++)c=e[b].getAttribute("data-content-id"),c==a?(domUtils.addClass(e[b],"focus"),domUtils.addClass($G(c),"focus")):(domUtils.removeClasses(e[b],"focus"),domUtils.removeClasses($G(c),"focus"));switch(a){case "upload":r=r||new w("queueList");break;case "online":n=n||new x("fileList")}}}function C(){dialog.onok=function(){for(var a=[],b,c=$G("tabhead").children,e=0;e<c.length;e++)if(domUtils.hasClass(c[e],"focus")){b=c[e].getAttribute("data-content-id");break}switch(b){case "upload":a=r.getInsertList();if(b=r.getQueueCount())return $(".info","#queueList").html('\x3cspan style\x3d"color:red;"\x3e'+"\u8fd8\u67092\u4e2a\u672a\u4e0a\u4f20\u6587\u4ef6".replace(/[\d]/,b)+"\x3c/span\x3e"),!1;break;case "online":a=n.getInsertList()}editor.execCommand("insertfile",a)}}function w(a){this.$wrap=a.constructor==String?$("#"+a):$(a);this.init()}function x(a){this.container=utils.isString(a)?document.getElementById(a):a;this.init()}var r,n;window.onload=function(){z();C()};w.prototype={init:function(){this.fileList=[];this.initContainer();this.initUploader()},initContainer:function(){this.$queue=this.$wrap.find(".filelist")},initUploader:function(){function a(a){var b=g('\x3cli id\x3d"'+a.id+'"\x3e\x3cp class\x3d"title"\x3e'+a.name+'\x3c/p\x3e\x3cp class\x3d"imgWrap"\x3e\x3c/p\x3e\x3cp class\x3d"progress"\x3e\x3cspan\x3e\x3c/span\x3e\x3c/p\x3e\x3c/li\x3e'),c=g('\x3cdiv class\x3d"file-panel"\x3e\x3cspan class\x3d"cancel"\x3e'+lang.uploadDelete+'\x3c/span\x3e\x3cspan class\x3d"rotateRight"\x3e'+lang.uploadTurnRight+'\x3c/span\x3e\x3cspan class\x3d"rotateLeft"\x3e'+lang.uploadTurnLeft+"\x3c/span\x3e\x3c/div\x3e").appendTo(b),e=b.find("p.progress span"),d=b.find("p.imgWrap"),k=g('\x3cp class\x3d"error"\x3e\x3c/p\x3e').hide().appendTo(b),h=function(a){switch(a){case "exceed_size":text=lang.errorExceedSize;break;case "interrupt":text=lang.errorInterrupt;break;case "http":text=lang.errorHttp;break;case "not_allow_type":text=lang.errorFileType;break;default:text=lang.errorUploadRetry}k.text(text).show()};"invalid"===a.getStatus()?h(a.statusText):(d.text(lang.uploadPreview),-1=="|png|jpg|jpeg|bmp|gif|".indexOf("|"+a.ext.toLowerCase()+"|")?d.empty().addClass("notimage").append('\x3ci class\x3d"file-preview file-type-'+a.ext.toLowerCase()+'"\x3e\x3c/i\x3e\x3cspan class\x3d"file-title" title\x3d"'+a.name+'"\x3e'+a.name+"\x3c/span\x3e"):browser.ie&&7>=browser.version?d.text(lang.uploadNoPreview):f.makeThumb(a,function(a,b){if(a||!b)d.text(lang.uploadNoPreview);else{var c=g('\x3cimg src\x3d"'+b+'"\x3e');d.empty().append(c);c.on("error",function(){d.text(lang.uploadNoPreview)})}},v,w),t[a.id]=[a.size,0],a.rotation=0,a.ext&&-1!=z.indexOf(a.ext.toLowerCase())||(h("not_allow_type"),f.removeFile(a)));a.on("statuschange",function(d,f){"progress"===f?e.hide().width(0):"queued"===f&&(b.off("mouseenter mouseleave"),c.remove());"error"===d||"invalid"===d?(h(a.statusText),t[a.id][1]=1):"interrupt"===d?h("interrupt"):"queued"===d?t[a.id][1]=0:"progress"===d&&(k.hide(),e.css("display","block"));b.removeClass("state-"+f).addClass("state-"+d)});b.on("mouseenter",function(){c.stop().animate({height:30})});b.on("mouseleave",function(){c.stop().animate({height:0})});c.on("click","span",function(){var b;switch(g(this).index()){case 0:f.removeFile(a);return;case 1:a.rotation+=90;break;case 2:a.rotation-=90}x?(b="rotate("+a.rotation+"deg)",d.css({"-webkit-transform":b,"-mos-transform":b,"-o-transform":b,transform:b})):d.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation\x3d"+~~(a.rotation/90%4+4)%4+")")});b.insertBefore(r)}function b(){var a=0,b=0,c=q.children(),d;g.each(t,function(c,d){b+=d[0];a+=d[0]*d[1]});d=b?a/b:0;c.eq(0).text(Math.round(100*d)+"%");c.eq(1).css("width",Math.round(100*d)+"%");e()}function c(a,b){if(a!=h){var g=f.getStats();k.removeClass("state-"+h);k.addClass("state-"+a);switch(a){case "pedding":B.addClass("element-invisible");p.addClass("element-invisible");n.removeClass("element-invisible");q.hide();m.hide();f.refresh();break;case "ready":n.addClass("element-invisible");B.removeClass("element-invisible");p.removeClass("element-invisible");q.hide();m.show();k.text(lang.uploadStart);f.refresh();break;case "uploading":q.show();m.hide();k.text(lang.uploadPause);break;case "paused":q.show();m.hide();k.text(lang.uploadContinue);break;case "confirm":q.show();m.hide();k.text(lang.uploadStart);g=f.getStats();if(g.successNum&&!g.uploadFailNum){c("finish");return}break;case "finish":q.hide(),m.show(),g.uploadFailNum?k.text(lang.uploadRetry):k.text(lang.uploadStart)}h=a;e()}d.getQueueCount()?k.removeClass("disabled"):k.addClass("disabled")}function e(){var a="",b;"ready"===h?a=lang.updateStatusReady.replace("_",u).replace("_KB",WebUploader.formatSize(y)):"confirm"===h?(b=f.getStats(),b.uploadFailNum&&(a=lang.updateStatusConfirm.replace("_",b.successNum).replace("_",b.successNum))):(b=f.getStats(),a=lang.updateStatusFinish.replace("_",u).replace("_KB",WebUploader.formatSize(y)).replace("_",b.successNum),b.uploadFailNum&&(a+=lang.updateStatusError.replace("_",b.uploadFailNum)));m.html(a)}var d=this,g=jQuery,l=d.$wrap,B=l.find(".filelist"),p=l.find(".statusBar"),m=p.find(".info"),k=l.find(".uploadBtn");l.find(".filePickerBtn");var r=l.find(".filePickerBlock"),n=l.find(".placeholder"),q=p.find(".progress").hide(),u=0,y=0,l=window.devicePixelRatio||1,v=113*l,w=113*l,h="",t={},x=function(){var a=document.createElement("p").style;return"transition"in a||"WebkitTransition"in a||"MozTransition"in a||"msTransition"in a||"OTransition"in a}(),f,A=editor.getActionUrl(editor.getOpt("fileActionName")),l=editor.getOpt("fileMaxSize"),z=(editor.getOpt("fileAllowFiles")||[]).join("").replace(/\./g,",").replace(/^[,]/,"");WebUploader.Uploader.support()?editor.getOpt("fileActionName")?(f=d.uploader=WebUploader.create({pick:{id:"#filePickerReady",label:lang.uploadSelectFile},swf:"../../third-party/webuploader/Uploader.swf",server:A,fileVal:editor.getOpt("fileFieldName"),duplicate:!0,fileSingleSizeLimit:l,compress:!1}),f.addButton({id:"#filePickerBlock"}),f.addButton({id:"#filePickerBtn",label:lang.uploadAddFile}),c("pedding"),f.on("fileQueued",function(b){u++;y+=b.size;1===u&&(n.addClass("element-invisible"),p.show());a(b)}),f.on("fileDequeued",function(a){u--;y-=a.size;var c=g("#"+a.id);delete t[a.id];b();c.off().find(".file-panel").off().end().remove();b()}),f.on("filesQueued",function(a){f.isInProgress()||"pedding"!=h&&"finish"!=h&&"confirm"!=h&&"ready"!=h||c("ready");b()}),f.on("all",function(a,b){switch(a){case "uploadFinished":c("confirm",b);break;case "startUpload":var d=utils.serializeParam(editor.queryCommandValue("serverparam"))||"",d=utils.formatUrl(A+(-1==A.indexOf("?")?"?":"\x26")+"encode\x3dutf-8\x26"+d);f.option("server",d);c("uploading",b);break;case "stopUpload":c("paused",b)}}),f.on("uploadBeforeSend",function(a,b,c){c.X_Requested_With="XMLHttpRequest"}),f.on("uploadProgress",function(a,c){g("#"+a.id).find(".progress span").css("width",100*c+"%");t[a.id][1]=c;b()}),f.on("uploadSuccess",function(a,b){var c=g("#"+a.id);try{var e=utils.str2json(b._raw||b);"SUCCESS"==e.state?(d.fileList.push(e),c.append('\x3cspan class\x3d"success"\x3e\x3c/span\x3e')):c.find(".error").text(e.state).show()}catch(f){c.find(".error").text(lang.errorServerUpload).show()}}),f.on("uploadError",function(a,b){}),f.on("error",function(b,c){"Q_TYPE_DENIED"!=b&&"F_EXCEED_SIZE"!=b||a(c)}),f.on("uploadComplete",function(a,b){}),k.on("click",function(){if(g(this).hasClass("disabled"))return!1;"ready"===h?f.upload():"paused"===h?f.upload():"uploading"===h&&f.stop()}),k.addClass("state-"+h),b()):g("#filePickerReady").after(g("\x3cdiv\x3e").html(lang.errorLoadConfig)).hide():g("#filePickerReady").after(g("\x3cdiv\x3e").html(lang.errorNotSupport)).hide()},getQueueCount:function(){var a,b,c=0,e=this.uploader.getFiles();for(b=0;a=e[b++];)a=a.getStatus(),"queued"!=a&&"uploading"!=a&&"progress"!=a||c++;return c},getInsertList:function(){var a,b,c,e=[],d=editor.getOpt("fileUrlPrefix");for(a=0;a<this.fileList.length;a++)c=this.fileList[a],b=c.url,e.push({title:c.original||b.substr(b.lastIndexOf("/")+1),url:d+b});return e}};x.prototype={init:function(){this.initContainer();this.initEvents();this.initData()},initContainer:function(){this.container.innerHTML="";this.list=document.createElement("ul");this.clearFloat=document.createElement("li");domUtils.addClass(this.list,"list");domUtils.addClass(this.clearFloat,"clearFloat");this.list.appendChild(this.clearFloat);this.container.appendChild(this.list)},initEvents:function(){var a=this;domUtils.on($G("fileList"),"scroll",function(b){10>this.scrollHeight-(this.offsetHeight+this.scrollTop)&&a.getFileData()});domUtils.on(this.list,"click",function(a){a=(a.target||a.srcElement).parentNode;"li"==a.tagName.toLowerCase()&&(domUtils.hasClass(a,"selected")?domUtils.removeClasses(a,"selected"):domUtils.addClass(a,"selected"))})},initData:function(){this.state=0;this.listSize=editor.getOpt("fileManagerListSize");this.listIndex=0;this.listEnd=!1;this.getFileData()},getFileData:function(){var a=this;a.listEnd||this.isLoadingData||(this.isLoadingData=!0,ajax.request(editor.getActionUrl(editor.getOpt("fileManagerActionName")),{timeout:1E5,data:utils.extend({start:this.listIndex,size:this.listSize},editor.queryCommandValue("serverparam")),method:"get",onsuccess:function(b){try{var c=eval("("+b.responseText+")");"SUCCESS"==c.state&&(a.pushData(c.list),a.listIndex=parseInt(c.start)+parseInt(c.list.length),a.listIndex>=c.total&&(a.listEnd=!0),a.isLoadingData=!1)}catch(e){-1!=b.responseText.indexOf("ue_separate_ue")&&(b=b.responseText.split(b.responseText),a.pushData(b),a.listIndex=parseInt(b.length),a.listEnd=!0,a.isLoadingData=!1)}},onerror:function(){a.isLoadingData=!1}}))},pushData:function(a){var b,c,e,d,g,l=this,n=editor.getOpt("fileManagerUrlPrefix");for(b=0;b<a.length;b++)if(a[b]&&a[b].url){c=document.createElement("li");g=document.createElement("span");e=a[b].url.substr(a[b].url.lastIndexOf(".")+1);if(-1!="png|jpg|jpeg|gif|bmp".indexOf(e))d=document.createElement("img"),domUtils.on(d,"load",function(a){return function(){l.scale(a,a.parentNode.offsetWidth,a.parentNode.offsetHeight)}}(d)),d.width=113,d.setAttribute("src",n+a[b].url+(-1==a[b].url.indexOf("?")?"?noCache\x3d":"\x26noCache\x3d")+(+new Date).toString(36));else{var p=document.createElement("i"),m=document.createElement("span");m.innerHTML=a[b].url.substr(a[b].url.lastIndexOf("/")+1);d=document.createElement("div");d.appendChild(p);d.appendChild(m);domUtils.addClass(d,"file-wrapper");domUtils.addClass(m,"file-title");domUtils.addClass(p,"file-type-"+e);domUtils.addClass(p,"file-preview")}domUtils.addClass(g,"icon");c.setAttribute("data-url",n+a[b].url);a[b].original&&c.setAttribute("data-title",a[b].original);c.appendChild(d);c.appendChild(g);this.list.insertBefore(c,this.clearFloat)}},scale:function(a,b,c,e){var d=a.width,g=a.height;"justify"==e?d>=g?(a.width=b,a.height=c*g/d,a.style.marginLeft="-"+parseInt((a.width-b)/2)+"px"):(a.width=b*d/g,a.height=c,a.style.marginTop="-"+parseInt((a.height-c)/2)+"px"):d>=g?(a.width=b*d/g,a.height=c,a.style.marginLeft="-"+parseInt((a.width-b)/2)+"px"):(a.width=b,a.height=c*g/d,a.style.marginTop="-"+parseInt((a.height-c)/2)+"px")},getInsertList:function(){var a,b=this.list.children,c=[];for(a=0;a<b.length;a++)if(domUtils.hasClass(b[a],"selected")){var e=b[a].getAttribute("data-url"),d=b[a].getAttribute("data-title")||e.substr(e.lastIndexOf("/")+1);c.push({title:d,url:e})}return c}}})();