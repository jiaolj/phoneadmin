/**
 * Created with JetBrains PhpStorm.
 * User: xuheng
 * Date: 12-5-22
 * Time: 上午11:38
 * To change this template use File | Settings | File Templates.
 */var scrawl=function(f){f&&this.initOptions(f)};(function(){var f=$G("J_brushBoard"),c=f.getContext("2d"),e=[],d=0;scrawl.prototype={isScrawl:!1,brushWidth:-1,brushColor:"",initOptions:function(a){this.originalState(a);this._buildToolbarColor(a.colorList);this._addBoardListener(a.saveNum);this._addOPerateListener(a.saveNum);this._addColorBarListener();this._addBrushBarListener();this._addEraserBarListener();this._addAddImgListener();this._addRemoveImgListenter();this._addScalePicListenter();this._addClearSelectionListenter();this._originalColorSelect(a.drawBrushColor);this._originalBrushSelect(a.drawBrushSize);this._clearSelection()},originalState:function(a){this.brushWidth=a.drawBrushSize;this.brushColor=a.drawBrushColor;c.lineWidth=this.brushWidth;c.strokeStyle=this.brushColor;c.fillStyle="transparent";c.lineCap="round";c.fill()},_buildToolbarColor:function(a){var b,g=[];g.push("\x3ctable id\x3d'J_colorList'\x3e");for(var d=0;b=a[d++];)0==(d-1)%5&&(1!=d&&g.push("\x3c/tr\x3e"),g.push("\x3ctr\x3e")),b="#"+b,g.push("\x3ctd\x3e\x3ca title\x3d'"+b+"' href\x3d'javascript:void(0)' style\x3d'background-color:"+b+"'\x3e\x3c/a\x3e\x3c/td\x3e");g.push("\x3c/tr\x3e\x3c/table\x3e");$G("J_colorBar").innerHTML=g.join("")},_addBoardListener:function(a){var b=this,g=0,h=-1,k=-1,m=!1,n=!1,r=!1,p=0,q,l="",g=parseInt(domUtils.getComputedStyle($G("J_wrap"),"margin-left"));e.push(c.getImageData(0,0,c.canvas.width,c.canvas.height));d+=1;domUtils.on(f,["mousedown","mousemove","mouseup","mouseout"],function(d){q=browser.webkit?d.which:p;switch(d.type){case "mousedown":l=p=1;m=!0;n=r=!1;b.isScrawl=!0;h=d.clientX-g;k=d.clientY-g;c.beginPath();break;case "mousemove":if(!l&&0==q)break;!l&&q&&(h=d.clientX-g,k=d.clientY-g,c.beginPath(),l=1);if(r||!m)break;var e=d.clientX-g;d=d.clientY-g;c.moveTo(h,k);c.lineTo(e,d);c.stroke();h=e;k=d;n=!0;break;case "mouseup":p=0;if(!m)break;n||(c.arc(h,k,c.lineWidth,0,2*Math.PI,!1),c.fillStyle=c.strokeStyle,c.fill());c.closePath();b._saveOPerate(a);n=m=!1;r=!0;k=h=-1;break;case "mouseout":l="",p=0,1!=q&&c.closePath()}})},_addOPerateListener:function(a){var b=this;domUtils.on($G("J_previousStep"),"click",function(){1<d&&(--d,c.clearRect(0,0,c.canvas.width,c.canvas.height),c.putImageData(e[d-1],0,0),b.btn2Highlight("J_nextStep"),1==d&&b.btn2disable("J_previousStep"))});domUtils.on($G("J_nextStep"),"click",function(){0<d&&d<e.length&&(c.clearRect(0,0,c.canvas.width,c.canvas.height),c.putImageData(e[d],0,0),d+=1,b.btn2Highlight("J_previousStep"),d==e.length&&b.btn2disable("J_nextStep"))});domUtils.on($G("J_clearBoard"),"click",function(){c.clearRect(0,0,c.canvas.width,c.canvas.height);e=[];b._saveOPerate(a);d=1;b.isScrawl=!1;b.btn2disable("J_previousStep");b.btn2disable("J_nextStep");b.btn2disable("J_clearBoard")})},_addColorBarListener:function(){var a=this;domUtils.on($G("J_colorBar"),"click",function(b){b=a.getTarget(b);var d=b.title;d&&(a._addColorSelect(b),a.brushColor=d,c.globalCompositeOperation="source-over",c.lineWidth=a.brushWidth,c.strokeStyle=d)})},_addBrushBarListener:function(){var a=this;domUtils.on($G("J_brushBar"),"click",function(b){b=a.getTarget(b);var d=browser.ie?b.innerText:b.text;d&&(a._addBESelect(b),c.globalCompositeOperation="source-over",c.lineWidth=parseInt(d),c.strokeStyle=a.brushColor,a.brushWidth=c.lineWidth)})},_addEraserBarListener:function(){var a=this;domUtils.on($G("J_eraserBar"),"click",function(b){b=a.getTarget(b);var d=browser.ie?b.innerText:b.text;d&&(a._addBESelect(b),c.lineWidth=parseInt(d),c.globalCompositeOperation="destination-out",c.strokeStyle="#FFF")})},_addAddImgListener:function(){var a=$G("J_imgTxt");window.FileReader||($G("J_addImg").style.display="none",$G("J_removeImg").style.display="none",$G("J_sacleBoard").style.display="none");domUtils.on(a,"change",function(b){var d=a.parentNode;addMaskLayer(lang.backgroundUploading);b=b.target||b.srcElement;var c=new FileReader;c.onload=function(a){ue_callback((a.target||a.srcElement).result,"SUCCESS")};c.readAsDataURL(b.files[0]);d.reset()})},_addRemoveImgListenter:function(){var a=this;domUtils.on($G("J_removeImg"),"click",function(){$G("J_picBoard").innerHTML="";a.btn2disable("J_removeImg");a.btn2disable("J_sacleBoard")})},_addScalePicListenter:function(){domUtils.on($G("J_sacleBoard"),"click",function(){var a=$G("J_picBoard"),b=$G("J_scaleCon"),d=a.children[0];d&&(b?"visible"==b.style.visibility?(b.style.visibility="hidden",a.style.position="",a.style.zIndex=""):(b.style.visibility="visible",a.style.cssText+="position:relative;z-index:999"):(a.style.cssText="position:relative;z-index:999;"+a.style.cssText,d.style.cssText="position: absolute;top:"+(f.height-d.height)/2+"px;left:"+(f.width-d.width)/2+"px;",b=new ScaleBoy,a.appendChild(b.init()),b.startScale(d)))})},_addClearSelectionListenter:function(){var a=document;domUtils.on(a,"mousemove",function(b){browser.ie&&11>browser.version?a.selection.clear():window.getSelection().removeAllRanges()})},_clearSelection:function(){for(var a=["J_operateBar","J_colorBar","J_brushBar","J_eraserBar","J_picBoard"],b=0,d;d=a[b++];)domUtils.unSelectable($G(d))},_saveOPerate:function(a){e.length<=a?d<e.length&&(this.btn2disable("J_nextStep"),e.splice(d)):e.shift();e.push(c.getImageData(0,0,c.canvas.width,c.canvas.height));d=e.length;this.btn2Highlight("J_previousStep");this.btn2Highlight("J_clearBoard")},_originalColorSelect:function(a){for(var b=$G("J_colorList").getElementsByTagName("td"),d=0,c;c=b[d++];)c.children[0].title.toLowerCase()==a&&(c.children[0].style.opacity=1)},_originalBrushSelect:function(a){for(var b=$G("J_brushBar").children,d=0,c;c=b[d++];)"a"==c.tagName.toLowerCase()&&(browser.ie?c.innerText:c.text).toLowerCase()==a&&(c.style.opacity=1)},_addColorSelect:function(a){for(var b=$G("J_colorList").getElementsByTagName("td"),d=$G("J_eraserBar").children,c=$G("J_brushBar").children,e=0,f;f=b[e++];)f.children[0].style.opacity=.3;for(b=0;e=c[b++];)"a"==e.tagName.toLowerCase()&&(e.style.opacity=.3,(browser.ie?e.innerText:e.text).toLowerCase()==this.brushWidth&&(e.style.opacity=1));for(c=0;b=d[c++];)"a"==b.tagName.toLowerCase()&&(b.style.opacity=.3);a.style.opacity=1;a.blur()},_addBESelect:function(a){for(var b=$G("J_brushBar").children,d=$G("J_eraserBar").children,c=0,e;e=b[c++];)"a"==e.tagName.toLowerCase()&&(e.style.opacity=.3);for(b=0;c=d[b++];)"a"==c.tagName.toLowerCase()&&(c.style.opacity=.3);a.style.opacity=1;a.blur()},getCanvasData:function(){var a=$G("J_picBoard"),b=a.children[0];if(b){var d;"absolute"==b.style.position?(d=parseInt(b.style.left),a=parseInt(b.style.top)):(d=(a.offsetWidth-b.width)/2,a=(a.offsetHeight-b.height)/2);c.globalCompositeOperation="destination-over";c.drawImage(b,d,a,b.width,b.height)}else c.globalCompositeOperation="destination-atop",c.fillStyle="#fff",c.fillRect(0,0,f.width,f.height);try{return f.toDataURL("image/png").substring(22)}catch(e){return""}},btn2Highlight:function(a){a=$G(a);-1==a.className.indexOf("H")&&(a.className+="H")},btn2disable:function(a){a=$G(a);-1!=a.className.indexOf("H")&&(a.className=a.className.replace("H",""))},getTarget:function(a){return a.target||a.srcElement}}})();var ScaleBoy=function(){this.scalingElement=this.dom=null};(function(){function f(){var d=document,a=d.getElementsByTagName("head")[0],b=d.createElement("style");b.type="text/css";try{b.appendChild(d.createTextNode(".scale{visibility:hidden;cursor:move;position:absolute;left:0;top:0;width:100px;height:50px;background-color:#fff;font-size:0;line-height:0;opacity:.4;filter:Alpha(opacity\x3d40);}.scale span{position:absolute;left:0;top:0;width:6px;height:6px;background-color:#006DAE;}.scale .hand0, .scale .hand7{cursor:nw-resize;}.scale .hand1, .scale .hand6{left:50%;margin-left:-3px;cursor:n-resize;}.scale .hand2, .scale .hand4, .scale .hand7{left:100%;margin-left:-6px;}.scale .hand3, .scale .hand4{top:50%;margin-top:-3px;cursor:w-resize;}.scale .hand5, .scale .hand6, .scale .hand7{margin-top:-6px;top:100%;}.scale .hand2, .scale .hand5{cursor:ne-resize;}"))}catch(c){b.styleSheet.cssText=".scale{visibility:hidden;cursor:move;position:absolute;left:0;top:0;width:100px;height:50px;background-color:#fff;font-size:0;line-height:0;opacity:.4;filter:Alpha(opacity\x3d40);}.scale span{position:absolute;left:0;top:0;width:6px;height:6px;background-color:#006DAE;}.scale .hand0, .scale .hand7{cursor:nw-resize;}.scale .hand1, .scale .hand6{left:50%;margin-left:-3px;cursor:n-resize;}.scale .hand2, .scale .hand4, .scale .hand7{left:100%;margin-left:-6px;}.scale .hand3, .scale .hand4{top:50%;margin-top:-3px;cursor:w-resize;}.scale .hand5, .scale .hand6, .scale .hand7{margin-top:-6px;top:100%;}.scale .hand2, .scale .hand5{cursor:ne-resize;}"}a.appendChild(b)}function c(){var d=[],a=document.createElement("div");a.id="J_scaleCon";a.className="scale";for(var b=0;8>b;b++)d.push("\x3cspan class\x3d'hand"+b+"'\x3e\x3c/span\x3e");a.innerHTML=d.join("");return a}var e=[[1,1,-1,-1],[0,1,0,-1],[0,1,1,-1],[1,0,-1,0],[0,0,1,0],[1,0,-1,1],[0,0,0,1],[0,0,1,1]];ScaleBoy.prototype={init:function(){f();var d=this,a=d.dom=c();d.scaleMousemove.fp=d;domUtils.on(a,"mousedown",function(a){var c=a.target||a.srcElement;d.start={x:a.clientX,y:a.clientY};-1!=c.className.indexOf("hand")&&(d.dir=c.className.replace("hand",""));domUtils.on(document.body,"mousemove",d.scaleMousemove);a.stopPropagation?a.stopPropagation():a.cancelBubble=!0});domUtils.on(document.body,"mouseup",function(b){d.start&&(domUtils.un(document.body,"mousemove",d.scaleMousemove),d.moved&&d.updateScaledElement({position:{x:a.style.left,y:a.style.top},size:{w:a.style.width,h:a.style.height}}),delete d.start,delete d.moved,delete d.dir)});return a},startScale:function(d){this.dom.style.cssText="visibility:visible;top:"+d.style.top+";left:"+d.style.left+";width:"+d.offsetWidth+"px;height:"+d.offsetHeight+"px;";this.scalingElement=d},updateScaledElement:function(d){var a=this.scalingElement,b=d.position;d=d.size;b&&("undefined"!=typeof b.x&&(a.style.left=b.x),"undefined"!=typeof b.y&&(a.style.top=b.y));d&&(d.w&&(a.style.width=d.w),d.h&&(a.style.height=d.h))},updateStyleByDir:function(d,a){var b=this.dom,c;e.def=[1,1,0,0];0!=e[d][0]&&(c=parseInt(b.style.left)+a.x,b.style.left=this._validScaledProp("left",c)+"px");0!=e[d][1]&&(c=parseInt(b.style.top)+a.y,b.style.top=this._validScaledProp("top",c)+"px");0!=e[d][2]&&(c=b.clientWidth+e[d][2]*a.x,b.style.width=this._validScaledProp("width",c)+"px");0!=e[d][3]&&(c=b.clientHeight+e[d][3]*a.y,b.style.height=this._validScaledProp("height",c)+"px");"def"===d&&this.updateScaledElement({position:{x:b.style.left,y:b.style.top}})},scaleMousemove:function(d){var a=arguments.callee.fp,b=a.start;a.updateStyleByDir(a.dir||"def",{x:d.clientX-b.x,y:d.clientY-b.y});arguments.callee.fp.start={x:d.clientX,y:d.clientY};arguments.callee.fp.moved=1},_validScaledProp:function(d,a){var b=this.dom,c=$G("J_picBoard");a=isNaN(a)?0:a;switch(d){case "left":return 0>a?0:a+b.clientWidth>c.clientWidth?c.clientWidth-b.clientWidth:a;case "top":return 0>a?0:a+b.clientHeight>c.clientHeight?c.clientHeight-b.clientHeight:a;case "width":return 0>=a?1:a+b.offsetLeft>c.clientWidth?c.clientWidth-b.offsetLeft:a;case "height":return 0>=a?1:a+b.offsetTop>c.clientHeight?c.clientHeight-b.offsetTop:a}}}})();function ue_callback(f,c){var e=document,d=$G("J_picBoard"),a=e.createElement("img");removeMaskLayer();"SUCCESS"==c?(d.innerHTML="",a.onload=function(){var b,c=this.width||void 0,e=this.height||void 0;if(300<c||300<e)if(c>=e){if(b=c-300)b=(b/c).toFixed(2),this.height=e-e*b,this.width=300}else if(b=e-300)b=(b/e).toFixed(2),this.width=c-c*b,this.height=300;d.appendChild(a);c=new scrawl;c.btn2Highlight("J_removeImg");c.btn2Highlight("J_sacleBoard")},a.src=f):alert(c)}function removeMaskLayer(){var f=$G("J_maskLayer");f.className="maskLayerNull";f.innerHTML="";dialog.buttons[0].setDisabled(!1)}function addMaskLayer(f){var c=$G("J_maskLayer");dialog.buttons[0].setDisabled(!0);c.className="maskLayer";c.innerHTML=f}function exec(f){if(f.isScrawl){addMaskLayer(lang.scrawlUpLoading);var c=f.getCanvasData();if(c){var e={timeout:1E5,onsuccess:function(a){if(!f.isCancelScrawl)if(a=eval("("+a.responseText+")"),"SUCCESS"==a.state){var b={},c=editor.options.scrawlUrlPrefix+a.url;b.src=c;b._src=c;b.alt=a.original||"";b.title=a.title||"";editor.execCommand("insertImage",b);dialog.close()}else alert(a.state)},onerror:function(){alert(lang.imageError);dialog.close()}};e[editor.getOpt("scrawlFieldName")]=c;var c=editor.getActionUrl(editor.getOpt("scrawlActionName")),d=utils.serializeParam(editor.queryCommandValue("serverparam"))||"",c=utils.formatUrl(c+(-1==c.indexOf("?")?"?":"\x26")+d);ajax.request(c,e)}}else addMaskLayer(lang.noScarwl+"\x26nbsp;\x26nbsp;\x26nbsp;\x3cinput type\x3d'button' value\x3d'"+lang.continueBtn+"'  onclick\x3d'removeMaskLayer()'/\x3e")};